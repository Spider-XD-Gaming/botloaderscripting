<!DOCTYPE html>
<html>
<head>
  <title>Family Tree</title>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; }
    #cy { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="cy"></div>
  <script>
    const getId = name => name.replace(/\s+/g, "_");
  
    fetch("data.json")
      .then(res => res.json())
      .then(rawData => {
        const definedNames = new Set(rawData.map(p => p.name));
        const referencedNames = new Set();
        const nodes = new Map(); // id -> node
        const edges = [];
  
        // Add known people
        for (const person of rawData) {
          const id = getId(person.name);
          nodes.set(id, {
            group: "nodes",
            data: { id, label: person.name, isPlaceholder: false }
          });
  
          // Collect referenced names
          person.partners.forEach(name => referencedNames.add(name));
          person.children.forEach(name => referencedNames.add(name));
        }
  
        // Add placeholder nodes for undefined referenced names
        for (const name of referencedNames) {
          if (!definedNames.has(name)) {
            const id = getId(name);
            if (!nodes.has(id)) {
              nodes.set(id, {
                group: "nodes",
                data: { id, label: name + " (unknown)", isPlaceholder: true }
              });
            }
          }
        }
  
        // Now create edges
        for (const person of rawData) {
          const sourceId = getId(person.name);
  
          for (const partner of person.partners) {
            const targetId = getId(partner);
            const edgeId = [sourceId, targetId].sort().join("-");
            edges.push({
              group: "edges",
              data: { id: edgeId, source: sourceId, target: targetId, label: "partner" }
            });
          }
  
          for (const child of person.children) {
            const targetId = getId(child);
            edges.push({
              group: "edges",
              data: {
                id: sourceId + "->" + targetId,
                source: sourceId,
                target: targetId,
                label: "child"
              }
            });
          }
        }

        const childNames = new Set();
        for (const person of rawData) {
          person.children.forEach(c => childNames.add(c));
        }
        
        const rootNames = rawData
          .map(p => p.name)
          .filter(name => !childNames.has(name));
        
        const rootIds = rootNames.map(getId);
  
        const cy = cytoscape({
          container: document.getElementById("cy"),
          elements: [...nodes.values(), ...edges],
          layout: {
            name: "breadthfirst",
            directed: true,
            spacingFactor: 1.5,
            orientation: "vertical",
            roots: rootIds
          },
          style: [
            {
              selector: "node",
              style: {
                "background-color": "#4f91ff",
                "label": "data(label)",
                "color": "#fff",
                "text-valign": "center",
                "text-halign": "center",
                "text-outline-color": "#000",
                "text-outline-width": 2,
                "font-size": "12px",
                "width": "label",
                "height": "label",
                "padding": "8px"
              }
            },
            {
              selector: "edge",
              style: {
                "width": 2,
                "line-color": "#aaa",
                "target-arrow-color": "#aaa",
                "target-arrow-shape": "triangle",
                "curve-style": "bezier",
                "label": "data(label)",
                "font-size": "10px",
                "color": "#ccc",
                "text-rotation": "autorotate",
                "text-margin-y": -5
              }
            }
          ]
        });
      });
  </script>
</body>
</html>
